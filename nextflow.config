nextflow.enable.dsl = 2

params {
    input_dir   = null
    pattern     = "**/*_{1,2}.fastq.gz"
    outdir      = "${projectDir}/results"
    hg38_dir    = null

    run_fastqc  = true
    fastp_args  = "--detect_adapter_for_pe --correction --trim_poly_g --trim_poly_x --cut_right --cut_window_size 4 --cut_mean_quality 20 --length_required 50"

    max_cpus    = 64
    max_memory = '128 GB'
    max_time   = '500 h'
}

profiles {

    standard {

        docker {
            enabled = true
        }

        process {
            executor = 'local'
            cpus     = 8
            memory   = '16 GB'
            time     = '12h'
        }
    }
}

process {

    /* QC - FastQC is I/O bound, more CPUs help with parallel decompression */
    withName: FASTQC {
        container = 'biocontainers/fastqc:v0.11.9_cv8'
        cpus = 8           // Reduced from 16 (diminishing returns)
        memory = '8 GB'    // Reduced from 60 GB (massive overkill)
        maxForks = 2       // Allow 2 samples in parallel
    }

    withName: FASTP {
        container = 'quay.io/biocontainers/fastp:0.23.2--h79da9fb_0'
        cpus = 16          // Increased from 8 (scales well)
        memory = '8 GB'    // Keep same
        maxForks = 2       // Allow 2 samples in parallel
    }

    /* Alignment - BWA-MEM scales well with threads */
    withName: BWAMEM_HG38 {
        container = 'quay.io/biocontainers/bwa:0.7.17--hed695b0_7'
        cpus = 16          // Increased from 4 (BWA scales well to ~16 threads)
        memory = '32 GB'   // Keep same
        maxForks = 2       // Allow 2 samples in parallel
    }

    withName: SAMTOOLS_SORT_HG38 {
        container = 'quay.io/biocontainers/samtools:1.11--h6270b1f_0'
        cpus = 8           // Increased from 4
        memory = '32 GB'   // Keep same
        maxForks = 2       // Increased from 1
    }

    /* VARIANT CALLERS - This is where the time is spent */
    
    withName: OCTOPUS_HG38_BWAMEM {
        container = 'cardiogen-wes-tools:latest'
        cpus = 48          // Increased from 32 (Octopus scales well)
        memory = '80 GB'   // Increased from 64 GB (might help with caching)
        maxForks = 1       // Keep sequential (memory-intensive)
        time = '4h'        // Add time limit
    }

    withName: MANTA_HG38_BWAMEM {
        container = 'cardiogen-wes-tools:latest'
        cpus = 16          // Reduced from 32 (doesn't scale beyond 16)
        memory = '16 GB'   // Reduced from 60 GB (uses <1 GB)
        maxForks = 2       // Increased from 1 (very fast, allow parallel)
    }

    withName: DELLY_HG38_BWAMEM {
        container = 'cardiogen-wes-tools:latest'
        cpus = 16          // Reduced from 32 (limited parallelization)
        memory = '8 GB'    // Reduced from 64 GB (uses <2 GB)
        maxForks = 2       // Increased from 1 (moderate, allow parallel)
    }
}
